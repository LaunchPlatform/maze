{% extends "base.html" %}
{% import "macros.html" as lib with context %}

{% block page_title %}
  View experiment {{ experiment.name }}
{% endblock %}

{% block js %}
{{ lib.dagre_js_libs() }}

<script>
// Create the input graph
var g = new dagreD3.graphlib.Graph({compound:true})
  .setGraph({})
  .setDefaultEdgeLabel(function() { return {}; });

// Here we're setting the nodes
g.setNode('a', {label: 'A'});
g.setNode('b', {label: 'B'});
g.setNode('c', {label: 'C'});
g.setNode('d', {label: 'D'});
g.setNode('e', {label: 'E'});
g.setNode('f', {label: 'F'});
g.setNode('g', {label: 'G'});
g.setNode('group', {label: 'Group', clusterLabelPos: 'top', style: 'fill: #d3d7e8'});
g.setNode('top_group', {label: 'Top Group', clusterLabelPos: 'bottom', style: 'fill: #ffd47f'});
g.setNode('bottom_group', {label: 'Bottom Group', style: 'fill: #5f9488'});

// Set the parents to define which nodes belong to which cluster
g.setParent('top_group', 'group');
g.setParent('bottom_group', 'group');
g.setParent('b', 'top_group');
g.setParent('c', 'bottom_group');
g.setParent('d', 'bottom_group');
g.setParent('e', 'bottom_group');
g.setParent('f', 'bottom_group');

// Set up edges, no special attributes.
g.setEdge('a', 'b');
g.setEdge('b', 'c');
g.setEdge('b', 'd');
g.setEdge('b', 'e');
g.setEdge('b', 'f');
g.setEdge('b', 'g');

g.nodes().forEach(function(v) {
  var node = g.node(v);
  // Round the corners of the nodes
  node.rx = node.ry = 5;
});


// Create the renderer
var render = new dagreD3.render();

// Set up an SVG group so that we can translate the final graph.
var svg = d3.select("svg"),
    svgGroup = svg.append("g");

// Run the renderer. This is what draws the final graph.
render(d3.select("svg g"), g);

// Center the graph
var xCenterOffset = (svg.attr("width") - g.graph().width) / 2;
svgGroup.attr("transform", "translate(" + xCenterOffset + ", 20)");
svg.attr("height", g.graph().height + 40);
</script>
{% endblock %}

{% block css %}
<style>

svg#svg-canvas {
  background-color: #eee;
}

.clusters rect {
  fill: #00ffd0;
  stroke: #999;
  stroke-width: 1.5px;
}

text {
  font-weight: 300;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serf;
  font-size: 14px;
}

.node rect {
  stroke: #999;
  fill: #fff;
  stroke-width: 1.5px;
}

.edgePath path {
  stroke: #333;
  stroke-width: 1.5px;
}

</style>
{% endblock %}


{% block content %}
<h1>Experiment: {{ experiment.name }}</h1>

<svg id="svg-canvas" width="100%" height="600"></svg>

<h2>Environments/Zones</h2>

<table class="table table-striped">
  <thead>
    <tr>
      <th scope="col">Env</th>
      <th scope="col">Zone #</th>
      <th scope="col">Initialized</th>
      <th scope="col" class="text-end">Slots</th>
      <th scope="col">Progress (Period {{ experiment.current_period.index }})</th>
    </tr>
  </thead>
  <tbody>
    {% for environment in experiment.environments %}
    <tr>
      <th scope="row">
        <a href="{{ url_for('view_environment', id=environment.id) }}">{{ environment.name }}</a>
      </th>
      <td></td>
      <td></td>
      <td class="text-end"></td>
      <td>
        {{ lib.progress_bar(environment.current_alive_avatars, environment.current_dead_avatars) }}
      </td>
    </tr>
      {% for zone in environment.zones %}
      <tr>
        <th scope="row">
        </th>
        <td>
          <a href="{{ url_for('view_zone', id=zone.id) }}">{{ zone.index }}</a>
        </td>
        <td>{{ zone.initialized }}</td>
        <td class="text-end">{{ zone.agent_slots | format_int }}</td>
        <td>
          {{ lib.progress_bar(zone.current_alive_avatars, zone.current_dead_avatars) }}
        </td>
      </tr>
      {% endfor %}
    {% endfor %}
  </tbody>
</table>

<h2>Periods</h2>
<ul>
  {% for period in experiment.periods %}
  <li>
    <div>{{ period.index }}</div>
  </li>
  {% endfor %}
</ul>

{% endblock content %}